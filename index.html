<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f17" />

  <!-- iOS å…¨å±ä¸å›¾æ ‡ -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Wallet" />
  <meta name="format-detection" content="telephone=no" />

  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon-192.png" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png" />
  <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png" />

  <title>Wallet Demo</title>

  <style>
    :root{
      --bg:#0b0f17;
      --card:#121a2a;
      --card2:#0f1626;
      --line:rgba(255,255,255,.10);
      --text:#e7eefc;
      --mut:rgba(231,238,252,.62);
      --blue:#3b82f6;
      --chip:rgba(255,255,255,.08);
      --shadow:0 16px 40px rgba(0,0,0,.35);
      --r:18px;
      --bad:#ef4444;
      --ok:#22c55e;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);}
    .app{max-width:520px;margin:0 auto;}
    .safe{
      padding:calc(14px + env(safe-area-inset-top)) 16px calc(86px + env(safe-area-inset-bottom));
    }

    .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .brand{display:flex;align-items:center;gap:10px;}
    .logo{
      width:38px;height:38px;border-radius:14px;
      background:rgba(255,255,255,.10);
      display:grid;place-items:center;font-weight:900;
      border:1px solid rgba(255,255,255,.10);
    }
    .title{font-size:16px;font-weight:900;margin:0;line-height:1;}
    .sub{font-size:12px;color:var(--mut);margin-top:4px;}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid rgba(255,255,255,.08);}

    .card{
      margin-top:12px;
      background:linear-gradient(180deg,var(--card),var(--card2));
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:16px;
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .card::after{
      content:"";
      position:absolute;right:-80px;top:-80px;
      width:180px;height:180px;border-radius:999px;
      background:rgba(59,130,246,.18);
    }
    .muted{color:var(--mut);font-size:12px;}
    .big{
      font-size:34px;font-weight:950;
      margin:10px 0 6px;letter-spacing:.2px;
    }
    .addr{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;word-break:break-all;color:rgba(231,238,252,.72);font-size:12px;}
    .actions{display:flex;gap:10px;margin-top:12px;}
    button{
      flex:1;padding:11px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.08);
      color:var(--text);font-weight:900;
    }
    button.primary{background:var(--blue);border-color:transparent;color:#fff;}
    button:disabled{opacity:.45}

    .sectionHead{display:flex;align-items:center;justify-content:space-between;margin:16px 2px 10px;}
    .sectionTitle{font-weight:950;font-size:14px;}
    .chip{font-size:12px;padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid rgba(255,255,255,.08);color:rgba(231,238,252,.8);}

    .list{display:flex;flex-direction:column;gap:10px;}
    .item{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px;border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
    }
    .left{display:flex;align-items:center;gap:10px;min-width:0;}
    .coinIcon{
      width:42px;height:42px;border-radius:16px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.10);
      display:grid;place-items:center;font-weight:950;
    }
    .nm{font-weight:950;font-size:14px;margin:0;}
    .sm{margin:3px 0 0;font-size:12px;color:var(--mut);}
    .right{text-align:right;}
    .v1{font-weight:950;}
    .v2{margin-top:3px;font-size:12px;color:var(--mut);}

    /* è¡¨å• */
    label{display:block;font-size:12px;color:rgba(231,238,252,.75);margin:12px 0 6px;}
    input,select{
      width:100%;padding:11px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:#0b1220;color:var(--text);outline:none;
    }
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .row{display:flex;gap:10px;}

    /* åº•éƒ¨å¯¼èˆª */
    .tabbar{
      position:fixed;left:0;right:0;bottom:0;
      padding:10px 14px calc(10px + env(safe-area-inset-bottom));
      background:rgba(11,15,23,.72);
      backdrop-filter: blur(12px);
      border-top:1px solid rgba(255,255,255,.08);
    }
    .tabs{max-width:520px;margin:0 auto;display:flex;gap:10px;}
    .tab{
      flex:1;padding:10px 12px;border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:rgba(231,238,252,.78);
      font-weight:900;
      display:flex;align-items:center;justify-content:center;gap:8px;
    }
    .tab.active{
      background:rgba(59,130,246,.22);
      border-color:rgba(59,130,246,.55);
      color:#fff;
    }

    /* å¼¹çª— */
    .mask{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:flex-end;padding:16px;}
    .modal{
      width:100%;max-width:520px;margin:0 auto;
      background:linear-gradient(180deg,var(--card),var(--card2));
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;padding:14px;box-shadow:0 24px 70px rgba(0,0,0,.5);
    }
    .modal h2{margin:6px 0 6px;font-size:16px;}
    .modalBtns{display:flex;gap:10px;margin-top:12px;}
    .danger{background:rgba(239,68,68,.18); border-color:rgba(239,68,68,.35);}
    .ok{background:rgba(34,197,94,.18); border-color:rgba(34,197,94,.35);}

    .kv{display:flex;justify-content:space-between;gap:10px;margin-top:8px;color:rgba(231,238,252,.86);font-size:12px;}
    .kv .k{color:rgba(231,238,252,.62);}
    .sep{height:1px;background:rgba(255,255,255,.08);margin:10px 0;}
    .tag{display:inline-block;font-size:12px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10);}

    .center{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;padding:26px 0;}
    .spinner{
      width:32px;height:32px;border-radius:999px;
      border:3px solid rgba(255,255,255,.18);
      border-top-color:rgba(255,255,255,.85);
      animation:spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg);} }
  </style>
</head>

<body>
  <div class="app">
    <div class="safe">

      <div class="topbar">
        <div class="brand">
          <div class="logo">W</div>
          <div>
            <div class="title">Wallet</div>
            <div class="sub">å…¨å± PWA Â· æœ¬åœ°æ¨¡æ‹Ÿ</div>
          </div>
        </div>
        <div class="pill" id="time"></div>
      </div>

      <!-- èµ„äº§æ€»è§ˆ -->
      <div class="card">
        <div class="muted">æ€»èµ„äº§ï¼ˆæ¼”ç¤ºï¼‰</div>
        <div class="big" id="total">$0.00</div>
        <div class="muted" style="margin-top:6px;">å±•ç¤ºåœ°å€</div>
        <div class="addr" id="addrShow"></div>

        <div class="actions">
          <button id="btnSend" class="primary">æ¨¡æ‹Ÿè½¬è´¦</button>
          <button disabled>æ¥æ”¶</button>
          <button id="btnSettings">è®¾ç½®</button>
        </div>

        <div class="muted" style="margin-top:10px;">
          æç¤ºï¼šè¿™æ˜¯æ¼”ç¤ºé’±åŒ…ï¼Œä½™é¢/æ‰‹ç»­è´¹/ç»“æœå‡ä¸ºæœ¬åœ°æ¨¡æ‹Ÿã€‚
        </div>
      </div>

      <!-- èµ„äº§é¡µ -->
      <div id="pageAssets">
        <div class="sectionHead">
          <div class="sectionTitle">èµ„äº§</div>
          <div class="chip" id="toggleHide">ğŸ‘ éšè—ä½™é¢</div>
        </div>
        <div class="list" id="assetList"></div>
      </div>

      <!-- è½¬è´¦é¡µ -->
      <div id="pageSend" style="display:none;">
        <div class="card" style="margin-top:12px;">
          <div class="muted">æ¨¡æ‹Ÿè½¬è´¦</div>
          <h2 style="margin:8px 0 0;font-size:16px;">å‘é€èµ„äº§</h2>

          <label>å¸ç§</label>
          <select id="sendAsset">
            <option value="BTC">BTC</option>
            <option value="ETH">ETH</option>
            <option value="USDT">USDT (ERC20)</option>
          </select>

          <label>æ”¶æ¬¾åœ°å€</label>
          <input id="sendTo" placeholder="0x... / bc1...ï¼ˆä»…æ¼”ç¤ºï¼‰" />

          <div class="grid2">
            <div>
              <label>é‡‘é¢</label>
              <input id="sendAmt" type="number" step="0.00000001" placeholder="ä¾‹å¦‚ 0.1" />
            </div>
            <div>
              <label>é€Ÿåº¦</label>
              <select id="sendSpeed">
                <option value="slow">æ…¢ï¼ˆçœæ‰‹ç»­è´¹ï¼‰</option>
                <option value="normal" selected>æ™®é€š</option>
                <option value="fast">å¿«ï¼ˆæ‰‹ç»­è´¹é«˜ï¼‰</option>
              </select>
            </div>
          </div>

          <div class="sep"></div>

          <div class="kv"><div class="k">é¢„è®¡æ‰‹ç»­è´¹</div><div id="feeLine">â€”</div></div>
          <div class="kv"><div class="k">åˆ°è´¦é‡‘é¢</div><div id="netLine">â€”</div></div>
          <div class="kv"><div class="k">æ‰‹ç»­è´¹è¯´æ˜</div><div id="feeHint" style="text-align:right;">â€”</div></div>

          <div class="row" style="margin-top:12px;">
            <button id="btnPreview" class="primary">é¢„è§ˆå¹¶ç¡®è®¤</button>
            <button id="btnFillDemo">å¡«å……ç¤ºä¾‹</button>
          </div>

          <div class="muted" style="margin-top:10px;">
            USDT(ERC20) æ‰‹ç»­è´¹ä»¥ ETH æ”¯ä»˜ï¼ˆæ¨¡æ‹Ÿé€»è¾‘ï¼‰ã€‚
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <div class="muted">æœ€è¿‘è½¬è´¦è®°å½•ï¼ˆæ¨¡æ‹Ÿï¼‰</div>
          <div id="txList" class="list" style="margin-top:10px;"></div>
        </div>
      </div>

      <!-- å…³äºé¡µ -->
      <div id="pageAbout" style="display:none;">
        <div class="card" style="margin-top:12px;">
          <div class="muted">å…³äº</div>
          <h2 style="margin:8px 0 6px;font-size:16px;">è¿™æ˜¯é’±åŒ…é£æ ¼ Demo</h2>
          <div class="muted">
            - ä¸è¿æ¥çœŸå®åŒºå—é“¾ï¼Œä¸ç”Ÿæˆäº¤æ˜“ã€‚<br/>
            - è½¬è´¦/æ‰‹ç»­è´¹/æˆåŠŸå¤±è´¥å‡ä¸ºæœ¬åœ°æ¨¡æ‹Ÿã€‚<br/>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- åº•éƒ¨å¯¼èˆª -->
  <div class="tabbar">
    <div class="tabs">
      <div class="tab active" id="tabAssets">èµ„äº§</div>
      <div class="tab" id="tabSend">è½¬è´¦</div>
      <div class="tab" id="tabAbout">æˆ‘çš„</div>
    </div>
  </div>

  <!-- é¦–æ¬¡å…è´£å£°æ˜ï¼ˆåªå¼¹ä¸€æ¬¡ï¼‰ -->
  <div class="mask" id="noticeMask">
    <div class="modal">
      <div class="muted">é¦–æ¬¡å¯åŠ¨æç¤º</div>
      <h2>è¿™æ˜¯æ¼”ç¤ºé’±åŒ…ï¼ˆDemoï¼‰</h2>
      <div class="muted">ä½™é¢/æ‰‹ç»­è´¹/è½¬è´¦ç»“æœéƒ½æ˜¯æœ¬åœ°æ¨¡æ‹Ÿï¼Œä»…ç”¨äºæ¼”ç¤ºï¼Œä¸ä»£è¡¨é“¾ä¸ŠçœŸå®èµ„äº§ï¼Œä¹Ÿä¸æ”¯æŒçœŸå®è½¬è´¦ã€‚</div>
      <div class="modalBtns">
        <button class="primary" id="noticeOk">æˆ‘çŸ¥é“äº†</button>
      </div>
    </div>
  </div>

  <!-- è®¾ç½®å¼¹çª— -->
  <div class="mask" id="settingsMask">
    <div class="modal">
      <div class="muted">è®¾ç½®ï¼ˆæœ¬åœ°ä¿å­˜ï¼‰</div>
      <h2>è‡ªå®šä¹‰ä½™é¢ / ä»·æ ¼</h2>

      <label>å±•ç¤ºåœ°å€ï¼ˆä»…å±•ç¤ºï¼‰</label>
      <input id="addr" placeholder="0x...ï¼ˆéšä¾¿å¡«ï¼Œä»…å±•ç¤ºï¼‰" />

      <div class="grid2">
        <div><label>BTC ä½™é¢</label><input id="btcBal" type="number" step="0.00000001" /></div>
        <div><label>BTC å•ä»·ï¼ˆUSDï¼‰</label><input id="btcPrice" type="number" step="0.01" /></div>

        <div><label>ETH ä½™é¢</label><input id="ethBal" type="number" step="0.00000001" /></div>
        <div><label>ETH å•ä»·ï¼ˆUSDï¼‰</label><input id="ethPrice" type="number" step="0.01" /></div>

        <div><label>USDT ä½™é¢</label><input id="usdtBal" type="number" step="0.00000001" /></div>
        <div><label>USDT å•ä»·ï¼ˆUSDï¼‰</label><input id="usdtPrice" type="number" step="0.01" /></div>
      </div>

      <div class="modalBtns">
        <button id="btnCancel">å–æ¶ˆ</button>
        <button class="primary" id="btnSave">ä¿å­˜å¹¶åº”ç”¨</button>
      </div>
    </div>
  </div>

  <!-- è½¬è´¦ç¡®è®¤å¼¹çª— -->
  <div class="mask" id="confirmMask">
    <div class="modal">
      <div class="muted">ç¡®è®¤è½¬è´¦ï¼ˆæ¨¡æ‹Ÿï¼‰</div>
      <h2>è¯·ç¡®è®¤ä¿¡æ¯</h2>

      <div class="kv"><div class="k">å¸ç§</div><div id="cSym">â€”</div></div>
      <div class="kv"><div class="k">æ”¶æ¬¾åœ°å€</div><div id="cTo" style="text-align:right;max-width:65%;word-break:break-all;">â€”</div></div>
      <div class="kv"><div class="k">é‡‘é¢</div><div id="cAmt">â€”</div></div>
      <div class="kv"><div class="k">æ‰‹ç»­è´¹</div><div id="cFee">â€”</div></div>
      <div class="kv"><div class="k">é¢„è®¡åˆ°è´¦</div><div id="cNet">â€”</div></div>
      <div class="sep"></div>
      <div class="muted" id="cHint">â€”</div>

      <div class="modalBtns">
        <button id="cBack">è¿”å›ä¿®æ”¹</button>
        <button class="primary" id="cSend">ç¡®è®¤å‘é€</button>
      </div>
    </div>
  </div>

  <!-- è½¬è´¦ç»“æœå¼¹çª— -->
  <div class="mask" id="resultMask">
    <div class="modal" id="resultModal">
      <div class="muted">è½¬è´¦ç»“æœï¼ˆæ¨¡æ‹Ÿï¼‰</div>
      <div id="resultBody"></div>
      <div class="modalBtns">
        <button class="primary" id="rOk">å®Œæˆ</button>
      </div>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);
  const fmt2 = (n)=> Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
  const fmtCoin = (n)=> Number(n||0).toLocaleString(undefined,{minimumFractionDigits:0, maximumFractionDigits:8});

  function setNow(){ $("time").textContent = new Date().toLocaleString(); }
  setNow(); setInterval(setNow, 1000);

  function randomAddr(){
    const bytes = crypto.getRandomValues(new Uint8Array(20));
    return "0x" + Array.from(bytes).map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  function randomTxid(){
    const bytes = crypto.getRandomValues(new Uint8Array(32));
    return "0x" + Array.from(bytes).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  const STORE_KEY = "wallet_demo_state_v3";
  const NOTICE_KEY = "wallet_demo_notice_once_v3";
  const HIDE_KEY = "wallet_demo_hide_v3";
  const TX_KEY = "wallet_demo_txs_v3";

  const defaultState = {
    addr: randomAddr(),
    assets: {
      BTC: { bal: 0.5234, price: 43000 },
      ETH: { bal: 8.12,   price: 3200  },
      USDT:{ bal: 12680,  price: 1     }
    }
  };

  function loadState(){
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw) return structuredClone(defaultState);
    try{
      const s = JSON.parse(raw);
      if(!s.addr) s.addr = randomAddr();
      if(!s.assets) s.assets = structuredClone(defaultState.assets);
      return s;
    }catch{
      return structuredClone(defaultState);
    }
  }
  function saveState(s){ localStorage.setItem(STORE_KEY, JSON.stringify(s)); }

  function loadTxs(){
    const raw = localStorage.getItem(TX_KEY);
    if(!raw) return [];
    try{ return JSON.parse(raw) || []; }catch{ return []; }
  }
  function saveTxs(list){
    localStorage.setItem(TX_KEY, JSON.stringify(list.slice(0, 20)));
  }

  function calcTotalUSD(s){
    let t = 0;
    for (const k of Object.keys(s.assets)){
      const a = s.assets[k];
      t += Number(a.bal||0) * Number(a.price||0);
    }
    return t;
  }

  function isHidden(){ return localStorage.getItem(HIDE_KEY)==="1"; }
  function setHidden(v){ localStorage.setItem(HIDE_KEY, v ? "1":"0"); }

  function setTab(which){
    const map = {
      assets: ["tabAssets","pageAssets"],
      send:   ["tabSend","pageSend"],
      about:  ["tabAbout","pageAbout"]
    };
    for(const k of Object.keys(map)){
      const [t,p] = map[k];
      $(t).classList.toggle("active", k===which);
      $(p).style.display = (k===which) ? "" : "none";
    }
  }

  function renderAssets(){
    const s = loadState();
    const hidden = isHidden();

    $("addrShow").textContent = s.addr;
    $("total").textContent = hidden ? "â€¢â€¢â€¢â€¢â€¢â€¢" : `$${fmt2(calcTotalUSD(s))}`;

    const list = $("assetList");
    list.innerHTML = "";
    const order = ["BTC","ETH","USDT"];
    for(const sym of order){
      const a = s.assets[sym];
      const usd = Number(a.bal||0) * Number(a.price||0);

      const item = document.createElement("div");
      item.className = "item";
      item.innerHTML = `
        <div class="left">
          <div class="coinIcon">${sym[0]}</div>
          <div style="min-width:0">
            <p class="nm">${sym}</p>
            <p class="sm">${hidden ? "â€¢â€¢â€¢â€¢â€¢â€¢" : (fmtCoin(a.bal) + " " + sym)}</p>
          </div>
        </div>
        <div class="right">
          <div class="v1">${hidden ? "â€¢â€¢â€¢â€¢â€¢â€¢" : ("$" + fmt2(usd))}</div>
          <div class="v2">${hidden ? "â€¢â€¢â€¢â€¢â€¢â€¢" : ("$" + fmt2(a.price) + " / " + sym)}</div>
        </div>
      `;
      list.appendChild(item);
    }

    $("toggleHide").textContent = hidden ? "ğŸ‘ æ˜¾ç¤ºä½™é¢" : "ğŸ‘ éšè—ä½™é¢";
  }

  function renderTxList(){
    const txs = loadTxs();
    const box = $("txList");
    box.innerHTML = "";
    if(txs.length===0){
      const empty = document.createElement("div");
      empty.className = "item";
      empty.innerHTML = `<div class="muted">æš‚æ— è½¬è´¦è®°å½•</div>`;
      box.appendChild(empty);
      return;
    }
    for(const t of txs){
      const it = document.createElement("div");
      it.className = "item";
      const statusTag = t.status === "success"
        ? `<span class="tag" style="border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.16);">æˆåŠŸ</span>`
        : `<span class="tag" style="border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.16);">å¤±è´¥</span>`;
      it.innerHTML = `
        <div class="left">
          <div class="coinIcon">${t.asset[0]}</div>
          <div style="min-width:0">
            <p class="nm">${t.asset} â†’ ${t.to.slice(0,6)}â€¦${t.to.slice(-4)}</p>
            <p class="sm">${t.time}</p>
          </div>
        </div>
        <div class="right">
          <div class="v1">${t.amt} ${t.asset}</div>
          <div class="v2">${statusTag}</div>
        </div>
      `;
      box.appendChild(it);
    }
  }

  // ===== æ‰‹ç»­è´¹æ¨¡æ‹Ÿé€»è¾‘ =====
  // BTCï¼šæŒ‰ sat/vB å’Œ vsize æ¨¡æ‹Ÿï¼ˆä¸ä¸¥æ ¼ï¼Œä½†çœ‹èµ·æ¥åƒï¼‰
  // ETHï¼šæŒ‰ gasPrice(gwei) * gasLimit
  // USDT(ERC20)ï¼šgasLimitæ›´é«˜ï¼Œæ‰‹ç»­è´¹ç”¨ ETH æ”¯ä»˜ï¼ˆæ¨¡æ‹Ÿï¼‰
  function estimateFee(state, asset, speed){
    const sp = speed || "normal";
    const m = (sp==="slow") ? 0.7 : (sp==="fast" ? 1.6 : 1.0);

    if(asset==="BTC"){
      const satPerVb = Math.round(18 * m);   // 18 sat/vB * m
      const vsize = 140;                    // ç®€åŒ–ï¼š140 vB
      const sats = satPerVb * vsize;
      const feeBTC = sats / 1e8;
      const feeUSD = feeBTC * (state.assets.BTC.price || 0);
      return { fee: feeBTC, feeAsset:"BTC", feeUSD, hint:`çŸ¿å·¥è´¹ï¼š${satPerVb} sat/vB Ã— ${vsize} vBï¼ˆæ¨¡æ‹Ÿï¼‰` };
    }

    if(asset==="ETH"){
      const gasPriceGwei = (sp==="slow") ? 12 : (sp==="fast" ? 38 : 22);
      const gasLimit = 21000;
      const feeETH = gasPriceGwei * 1e-9 * gasLimit;
      const feeUSD = feeETH * (state.assets.ETH.price || 0);
      return { fee: feeETH, feeAsset:"ETH", feeUSD, hint:`Gasï¼š${gasLimit} Ã— ${gasPriceGwei} gweiï¼ˆæ¨¡æ‹Ÿï¼‰` };
    }

    if(asset==="USDT"){
      const gasPriceGwei = (sp==="slow") ? 10 : (sp==="fast" ? 30 : 18);
      const gasLimit = 65000; // ERC20 è½¬è´¦æ›´é«˜
      const feeETH = gasPriceGwei * 1e-9 * gasLimit;
      const feeUSD = feeETH * (state.assets.ETH.price || 0);
      return { fee: feeETH, feeAsset:"ETH", feeUSD, hint:`USDT(ERC20) Gasï¼š${gasLimit} Ã— ${gasPriceGwei} gweiï¼Œæ‰‹ç»­è´¹ç”¨ ETH æ”¯ä»˜ï¼ˆæ¨¡æ‹Ÿï¼‰` };
    }

    return { fee: 0, feeAsset: asset, feeUSD: 0, hint:"â€”" };
  }

  function validateAddress(asset, to){
    const s = (to||"").trim();
    if(s.length < 12) return "åœ°å€å¤ªçŸ­";
    // è½»é‡â€œåƒæ ·â€çš„æ ¡éªŒï¼ˆä¸ä¸¥æ ¼ï¼‰
    if(asset==="BTC"){
      if(!(s.startsWith("bc1") || s.startsWith("1") || s.startsWith("3"))) return "BTC åœ°å€æ ¼å¼çœ‹èµ·æ¥ä¸å¯¹";
    }else{
      if(!(s.startsWith("0x") && s.length >= 26)) return "EVM åœ°å€æ ¼å¼çœ‹èµ·æ¥ä¸å¯¹";
    }
    return null;
  }

  function updateFeePreview(){
    const st = loadState();
    const asset = $("sendAsset").value;
    const speed = $("sendSpeed").value;
    const amt = Number($("sendAmt").value || 0);

    const est = estimateFee(st, asset, speed);
    const feeText = `${fmtCoin(est.fee)} ${est.feeAsset}  (â‰ˆ $${fmt2(est.feeUSD)})`;
    $("feeLine").textContent = feeText;
    $("feeHint").textContent = est.hint;

    // åˆ°è´¦é‡‘é¢ï¼šä¸€èˆ¬æ˜¯å¯¹æ–¹æ”¶åˆ° amtï¼›ä½†â€œä½ æ”¯å‡ºâ€ä¼šæœ‰æ‰‹ç»­è´¹
    $("netLine").textContent = `${fmtCoin(amt)} ${asset}`;
  }

  // ===== é¦–æ¬¡å…è´£å£°æ˜ï¼ˆåªå¼¹ä¸€æ¬¡ï¼‰=====
  (function firstNotice(){
    if(localStorage.getItem(NOTICE_KEY)==="1") return;
    $("noticeMask").style.display = "flex";
    $("noticeOk").onclick = ()=>{
      localStorage.setItem(NOTICE_KEY,"1");
      $("noticeMask").style.display = "none";
    };
  })();

  // ===== Tabs =====
  $("tabAssets").onclick = ()=>{ setTab("assets"); };
  $("tabSend").onclick = ()=>{ setTab("send"); renderTxList(); updateFeePreview(); };
  $("tabAbout").onclick = ()=>{ setTab("about"); };

  // ===== éšè—ä½™é¢ =====
  $("toggleHide").onclick = ()=>{
    setHidden(!isHidden());
    renderAssets();
  };

  // ===== è®¾ç½® =====
  function openSettings(){
    const s = loadState();
    $("addr").value = s.addr || "";
    $("btcBal").value = s.assets.BTC.bal ?? 0;
    $("btcPrice").value = s.assets.BTC.price ?? 0;
    $("ethBal").value = s.assets.ETH.bal ?? 0;
    $("ethPrice").value = s.assets.ETH.price ?? 0;
    $("usdtBal").value = s.assets.USDT.bal ?? 0;
    $("usdtPrice").value = s.assets.USDT.price ?? 0;
    $("settingsMask").style.display = "flex";
  }
  $("btnSettings").onclick = openSettings;
  $("btnCancel").onclick = ()=> $("settingsMask").style.display = "none";
  $("btnSave").onclick = ()=>{
    const s = loadState();
    s.addr = ($("addr").value || randomAddr()).trim();
    s.assets.BTC.bal = Number($("btcBal").value || 0);
    s.assets.BTC.price = Number($("btcPrice").value || 0);
    s.assets.ETH.bal = Number($("ethBal").value || 0);
    s.assets.ETH.price = Number($("ethPrice").value || 0);
    s.assets.USDT.bal = Number($("usdtBal").value || 0);
    s.assets.USDT.price = Number($("usdtPrice").value || 0);
    saveState(s);
    $("settingsMask").style.display = "none";
    renderAssets();
    updateFeePreview();
  };

  // ===== è¿›å…¥è½¬è´¦é¡µï¼ˆæŒ‰é’®/Tabï¼‰=====
  $("btnSend").onclick = ()=>{ setTab("send"); renderTxList(); updateFeePreview(); };

  // é¢„è§ˆå®æ—¶æ›´æ–°
  $("sendAsset").onchange = updateFeePreview;
  $("sendSpeed").onchange = updateFeePreview;
  $("sendAmt").oninput = updateFeePreview;

  // ç¤ºä¾‹å¡«å……
  $("btnFillDemo").onclick = ()=>{
    const asset = $("sendAsset").value;
    if(asset==="BTC"){
      $("sendTo").value = "bc1q9x3xqk3demoaddress9x3xqk3demo";
      $("sendAmt").value = "0.01";
    }else{
      $("sendTo").value = "0x9d8A62f656a8d1615C1294fd71e9CFb3E4855A4F";
      $("sendAmt").value = asset==="USDT" ? "250" : "0.5";
    }
    $("sendSpeed").value = "normal";
    updateFeePreview();
  };

  // ===== é¢„è§ˆå¹¶ç¡®è®¤ =====
  let pending = null;

  $("btnPreview").onclick = ()=>{
    const st = loadState();
    const asset = $("sendAsset").value;
    const to = ($("sendTo").value||"").trim();
    const amt = Number($("sendAmt").value || 0);
    const speed = $("sendSpeed").value;

    if(!to) return showResult("fail", "è½¬è´¦å¤±è´¥", "è¯·è¾“å…¥æ”¶æ¬¾åœ°å€ã€‚");
    const addrErr = validateAddress(asset, to);
    if(addrErr) return showResult("fail", "è½¬è´¦å¤±è´¥", addrErr + "ï¼ˆæ¨¡æ‹Ÿæ ¡éªŒï¼‰");

    if(!(amt>0)) return showResult("fail", "è½¬è´¦å¤±è´¥", "è¯·è¾“å…¥æ­£ç¡®é‡‘é¢ã€‚");

    const est = estimateFee(st, asset, speed);

    // ä½™é¢æ£€æŸ¥ï¼šUSDT è½¬è´¦éœ€è¦ USDT è¶³å¤Ÿ + ETH è¶³å¤Ÿæ”¯ä»˜æ‰‹ç»­è´¹
    if(asset==="USDT"){
      if(amt > Number(st.assets.USDT.bal||0)) return showResult("fail", "è½¬è´¦å¤±è´¥", "USDT ä½™é¢ä¸è¶³ã€‚");
      if(est.fee > Number(st.assets.ETH.bal||0)) return showResult("fail", "è½¬è´¦å¤±è´¥", "ETH ä½™é¢ä¸è¶³ä»¥æ”¯ä»˜ Gasã€‚");
    }else{
      const bal = Number(st.assets[asset].bal||0);
      const need = amt + (est.feeAsset===asset ? est.fee : 0);
      if(need > bal) return showResult("fail", "è½¬è´¦å¤±è´¥", `${asset} ä½™é¢ä¸è¶³ï¼ˆéœ€è¦å«æ‰‹ç»­è´¹ï¼‰ã€‚`);
    }

    pending = { asset, to, amt, speed, est };

    $("cSym").textContent = asset;
    $("cTo").textContent = to;
    $("cAmt").textContent = `${fmtCoin(amt)} ${asset}`;
    $("cFee").textContent = `${fmtCoin(est.fee)} ${est.feeAsset} (â‰ˆ $${fmt2(est.feeUSD)})`;
    $("cNet").textContent = `${fmtCoin(amt)} ${asset}`;
    $("cHint").textContent = est.hint;

    $("confirmMask").style.display = "flex";
  };

  $("cBack").onclick = ()=>{ $("confirmMask").style.display = "none"; };
  $("cSend").onclick = ()=>{
    if(!pending) return;
    $("confirmMask").style.display = "none";
    simulateSend(pending);
  };

  function simulateSend(p){
    // å¤„ç†ä¸­é¡µé¢ï¼ˆå¼¹çª—ï¼‰
    $("resultMask").style.display = "flex";
    $("resultModal").classList.remove("danger","ok");
    $("resultBody").innerHTML = `
      <div class="center">
        <div class="spinner"></div>
        <div style="font-weight:950;">æ­£åœ¨å¹¿æ’­äº¤æ˜“â€¦</div>
        <div class="muted">æ¨¡æ‹Ÿç½‘ç»œç¡®è®¤ä¸­ï¼ˆ${p.speed==="fast"?"å¿«":"æ™®é€š"}ï¼‰</div>
      </div>
    `;

    // æ¨¡æ‹Ÿ 1.2~2.2 ç§’
    const delay = 1200 + Math.floor(Math.random()*1000);
    setTimeout(()=>{
      // æˆåŠŸç‡ï¼šæ™®é€š 85%ï¼Œæ…¢ 78%ï¼Œå¿« 90%
      const base = (p.speed==="slow") ? 0.78 : (p.speed==="fast" ? 0.90 : 0.85);
      const ok = Math.random() < base;

      if(!ok){
        // æ¨¡æ‹Ÿå¤±è´¥åŸå› 
        const reasons = [
          "ç½‘ç»œæ‹¥å µï¼Œäº¤æ˜“æœªè¢«æ‰“åŒ…ï¼ˆæ¨¡æ‹Ÿï¼‰ã€‚",
          "æ‰‹ç»­è´¹è¿‡ä½ï¼Œäº¤æ˜“è¢«ä¸¢å¼ƒï¼ˆæ¨¡æ‹Ÿï¼‰ã€‚",
          "èŠ‚ç‚¹è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•ï¼ˆæ¨¡æ‹Ÿï¼‰ã€‚"
        ];
        const reason = reasons[Math.floor(Math.random()*reasons.length)];
        recordTx({ ...p, status:"fail", reason });
        showResult("fail", "è½¬è´¦å¤±è´¥", reason);
        renderTxList();
        return;
      }

      // æˆåŠŸï¼šæ‰£ä½™é¢ + è®°å½• tx
      const st = loadState();

      if(p.asset==="USDT"){
        st.assets.USDT.bal = Number(st.assets.USDT.bal||0) - p.amt;
        st.assets.ETH.bal = Number(st.assets.ETH.bal||0) - p.est.fee; // USDT gas ç”¨ ETH
      }else{
        st.assets[p.asset].bal = Number(st.assets[p.asset].bal||0) - p.amt;
        if(p.est.feeAsset===p.asset){
          st.assets[p.asset].bal -= p.est.fee;
        }else{
          // ç›®å‰ä¸ä¼šå‡ºç°
        }
      }

      saveState(st);
      renderAssets();

      const txid = randomTxid();
      recordTx({ ...p, status:"success", txid });

      showResult("success", "è½¬è´¦æˆåŠŸ", `äº¤æ˜“å·²æäº¤ï¼ˆæ¨¡æ‹Ÿï¼‰ã€‚\nTxID: ${txid}`);
      renderTxList();
    }, delay);
  }

  function recordTx(p){
    const txs = loadTxs();
    const time = new Date().toLocaleString();
    const rec = {
      time,
      asset: p.asset,
      to: p.to,
      amt: fmtCoin(p.amt),
      fee: fmtCoin(p.est.fee),
      feeAsset: p.est.feeAsset,
      speed: p.speed,
      status: p.status,
      txid: p.txid || null,
      reason: p.reason || null
    };
    txs.unshift(rec);
    saveTxs(txs);
  }

  function showResult(kind, title, detail){
    $("resultMask").style.display = "flex";
    $("resultModal").classList.toggle("danger", kind==="fail");
    $("resultModal").classList.toggle("ok", kind==="success");

    const icon = (kind==="success") ? "âœ…" : "âŒ";
    const lines = (detail||"").split("\n").map(s=>`<div class="muted" style="margin-top:6px;white-space:pre-wrap;">${escapeHtml(s)}</div>`).join("");

    $("resultBody").innerHTML = `
      <div class="center">
        <div style="font-size:34px;">${icon}</div>
        <div style="font-weight:950;font-size:18px;">${escapeHtml(title)}</div>
        ${lines}
      </div>
    `;
  }

  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  $("rOk").onclick = ()=>{ $("resultMask").style.display = "none"; };

  // SW
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js").catch(()=>{});
  }

  // åˆå§‹åŒ–
  renderAssets();
  renderTxList();
  updateFeePreview();

  // é»˜è®¤è¿›å…¥èµ„äº§é¡µ
  setTab("assets");
</script>
</body>
</html>
